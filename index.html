<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Block Utilization Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(to bottom right, #f8fafc, #f1f5f9); 
            min-height: 100vh; 
        }
        .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }
        .card { 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .btn { 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            cursor: pointer; 
            border: none; 
            transition: all 0.2s; 
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-purple { background: #9333ea; color: white; }
        .btn-purple:hover { background: #7e22ce; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background: #cbd5e1; }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .flex { display: flex; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-gap { gap: 0.5rem; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        h1 { font-size: 2rem; font-weight: bold; color: #1e293b; margin-bottom: 0.5rem; }
        h2 { font-size: 1.5rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; }
        h3 { font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; }
        select, input[type="file"] { 
            width: 100%; 
            padding: 0.5rem; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.5rem; 
        }
        label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        table { width: 100%; font-size: 0.875rem; }
        thead { background: #f1f5f9; position: sticky; top: 0; }
        th { padding: 0.75rem; font-weight: 600; text-align: left; }
        th.text-right { text-align: right; }
        td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background: #f8fafc; }
        .overflow-auto { overflow: auto; max-height: 24rem; }
        .spinner { 
            border: 4px solid #f3f4f6; 
            border-top: 4px solid #9333ea; 
            border-radius: 50%; 
            width: 4rem; 
            height: 4rem; 
            animation: spin 1s linear infinite; 
            margin: 0 auto; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .header-purple { 
            background: linear-gradient(to bottom right, #6366f1, #8b5cf6); 
            color: white; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            margin-bottom: 1.5rem; 
        }
        .text-green { color: #16a34a; font-weight: 600; }
        .text-yellow { color: #ca8a04; font-weight: 600; }
        .text-red { color: #dc2626; font-weight: 600; }
        .text-gray { color: #94a3b8; }
        .border-box { 
            border: 2px solid; 
            border-radius: 0.5rem; 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
        }
        .border-purple { 
            border-color: #e9d5ff; 
            background: linear-gradient(to right, #faf5ff, #fce7f3); 
        }
        .border-blue { 
            border-color: #bfdbfe; 
            background: linear-gradient(to right, #eff6ff, #e0e7ff); 
        }
        .text-small { font-size: 0.75rem; color: #64748b; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .highlight-row { background: #dbeafe; font-weight: 600; }
        .upload-input { 
            display: block; 
            width: 100%; 
            padding: 0.5rem; 
            border-radius: 0.5rem; 
            background: #16a34a; 
            color: white; 
            cursor: pointer; 
        }
        @media (max-width: 768px) { 
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // ================== CONFIGURATION ==================
        const CONFIG = {
            GITHUB_USERNAME: 'agvanguard',
            GITHUB_REPO: 'trainingblockutil-dashboard',
            EXCEL_FILENAME: 'Training Block Report Raw Data.xlsx'
        };

        // ================== STATE MANAGEMENT ==================
        const state = {
            rawData: [],
            filteredData: [],
            viewMode: 'weekly',
            filters: { 
                coach: 'All', 
                team: 'All', 
                subgroup: 'All', 
                month: 'All', 
                week: 'All' 
            },
            charts: { 
                trend: null, 
                subgroup: null, 
                team: null, 
                coach: null 
            }
        };

        // ================== UTILITY FUNCTIONS ==================
        
        /**
         * Convert Excel serial date to JavaScript Date
         */
        function excelDateToJSDate(serial) {
            if (!serial || isNaN(serial)) return null;
            const excelEpoch = new Date(1900, 0, 1);
            const daysToAdd = serial - 2;
            const result = new Date(excelEpoch);
            result.setDate(result.getDate() + daysToAdd);
            return new Date(result.getFullYear(), result.getMonth(), result.getDate());
        }

        /**
         * Format date as YYYY-MM-DD
         */
        function formatDate(date) {
            if (!date || !(date instanceof Date)) return null;
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        /**
         * Parse month string (e.g., "2024 - January") to Date for sorting
         */
        function parseMonthString(monthStr) {
            if (!monthStr || typeof monthStr !== 'string') return null;
            
            // Handle format: "YYYY - Month Name"
            const match = monthStr.match(/(\d{4})\s*-\s*(\w+)/);
            if (!match) return null;
            
            const year = parseInt(match[1]);
            const monthName = match[2];
            
            const monthMap = {
                'January': 0, 'February': 1, 'March': 2, 'April': 3,
                'May': 4, 'June': 5, 'July': 6, 'August': 7,
                'September': 8, 'October': 9, 'November': 10, 'December': 11
            };
            
            const monthIndex = monthMap[monthName];
            if (monthIndex === undefined) return null;
            
            return new Date(year, monthIndex, 1);
        }

        /**
         * Sort month strings chronologically
         */
        function sortMonths(months) {
            return months.sort((a, b) => {
                const dateA = parseMonthString(a);
                const dateB = parseMonthString(b);
                if (!dateA || !dateB) return 0;
                return dateA - dateB;
            });
        }

        /**
         * Check if value is an Excel error
         */
        function isErrorValue(val) {
            if (!val) return false;
            const str = String(val).trim();
            return str === '#N/A' || str === '#VALUE!' || str === 'NA' || 
                   str === '#REF!' || str === '#DIV/0!' || str === '#NUM!' || 
                   str === '#NAME?' || str === '#NULL!' || str.startsWith('#');
        }

        /**
         * Clean string value
         */
        function cleanValue(val) {
            return (val && !isErrorValue(val)) ? String(val).trim() : "";
        }

        /**
         * Clean numeric value
         */
        function cleanNumber(val) {
            if (!val || isErrorValue(val)) return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Check if value is valid (not null, empty, or error)
         */
        function isValidValue(val) {
            return val && val !== '' && !isErrorValue(val);
        }

        /**
         * Get color class based on utilization percentage
         */
        function getUtilizationColor(utilization) {
            if (utilization === '' || utilization === null || utilization === undefined) {
                return 'text-gray';
            }
            const val = parseFloat(utilization);
            if (val >= 50) return 'text-green';
            if (val >= 1) return 'text-yellow';
            return 'text-red';
        }

        /**
         * Calculate utilization percentage
         */
        function calculateUtilization(training, block) {
            if (!block || block === 0) return '';
            return ((training / block) * 100).toFixed(2);
        }

        // ================== DATA PROCESSING ==================

        /**
         * Process Excel file data
         */
        async function processExcelFile(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer);
                const sheetName = workbook.SheetNames.includes("Raw Data") 
                    ? "Raw Data" 
                    : workbook.SheetNames[0];
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

                state.rawData = data.map(row => {
                    // Process week start date
                    let weekStartDate = null;
                    const weekStartValue = row["Week Start"];
                    
                    if (weekStartValue && !isErrorValue(weekStartValue)) {
                        if (typeof weekStartValue === 'number') {
                            weekStartDate = excelDateToJSDate(weekStartValue);
                        } else if (weekStartValue instanceof Date) {
                            weekStartDate = weekStartValue;
                        } else if (typeof weekStartValue === 'string') {
                            weekStartDate = new Date(weekStartValue);
                        }
                    }
                    
                    return {
                        // Weekly data
                        weekStart: weekStartDate,
                        weeklyYearMonth: cleanValue(row["Year - Month"]),
                        weeklySubgroup: cleanValue(row.Subgroup),
                        weeklyCoach: cleanValue(row.Coach),
                        weeklyTeam: cleanValue(row.Team),
                        weeklyTrainingHours: cleanNumber(row["Training Total Hours"]),
                        weeklyBlockHours: cleanNumber(row["Total Training Block Hours"]),
                        
                        // Monthly data
                        monthlyYearMonth: cleanValue(row["Year - Month"]),
                        monthlySubgroup: cleanValue(row.Subgroup),
                        monthlyCoach: cleanValue(row.Coach),
                        monthlyTeam: cleanValue(row.Team),
                        monthlyTrainingHours: cleanNumber(row["Training Total Hours"]),
                        monthlyBlockHours: cleanNumber(row["Total Training Block Hours"])
                    };
                }).filter(row => row.weekStart && !isNaN(row.weekStart.getTime()));

                state.filteredData = [...state.rawData];
                renderDashboard();
            } catch (error) {
                throw new Error('Error processing file: ' + error.message);
            }
        }

        // ================== FILTERING ==================

        /**
         * Get filter options based on current view mode
         */
        function getFilterOptions() {
            const isWeekly = state.viewMode === 'weekly';
            
            const coaches = [...new Set(
                state.rawData
                    .map(d => isWeekly ? d.weeklyCoach : d.monthlyCoach)
                    .filter(isValidValue)
            )].sort();
            
            const teams = [...new Set(
                state.rawData
                    .map(d => isWeekly ? d.weeklyTeam : d.monthlyTeam)
                    .filter(isValidValue)
            )].sort();
            
            const subgroups = [...new Set(
                state.rawData
                    .map(d => isWeekly ? d.weeklySubgroup : d.monthlySubgroup)
                    .filter(isValidValue)
            )].sort();
            
            const weeks = [...new Set(
                state.rawData
                    .filter(d => d.weekStart)
                    .map(d => formatDate(d.weekStart))
                    .filter(Boolean)
            )].sort();
            
            // Get months and sort chronologically
            const months = [...new Set(
                state.rawData
                    .map(d => isWeekly ? d.weeklyYearMonth : d.monthlyYearMonth)
                    .filter(isValidValue)
            )];
            
            const sortedMonths = sortMonths(months);

            return { coaches, teams, subgroups, weeks, months: sortedMonths };
        }

        /**
         * Apply filters to data
         */
        function applyFilters() {
            const isWeekly = state.viewMode === 'weekly';
            state.filteredData = [...state.rawData];
            
            if (state.filters.coach !== 'All') {
                state.filteredData = state.filteredData.filter(d => 
                    (isWeekly ? d.weeklyCoach : d.monthlyCoach) === state.filters.coach
                );
            }
            
            if (state.filters.team !== 'All') {
                state.filteredData = state.filteredData.filter(d => 
                    (isWeekly ? d.weeklyTeam : d.monthlyTeam) === state.filters.team
                );
            }
            
            if (state.filters.subgroup !== 'All') {
                state.filteredData = state.filteredData.filter(d => 
                    (isWeekly ? d.weeklySubgroup : d.monthlySubgroup) === state.filters.subgroup
                );
            }
            
            if (!isWeekly && state.filters.month !== 'All') {
                state.filteredData = state.filteredData.filter(d => 
                    d.monthlyYearMonth === state.filters.month
                );
            }
            
            if (isWeekly && state.filters.week !== 'All') {
                state.filteredData = state.filteredData.filter(d => 
                    d.weekStart && formatDate(d.weekStart) === state.filters.week
                );
            }
            
            renderDashboard();
        }

        /**
         * Update a specific filter
         */
        function updateFilter(key, value) {
            state.filters[key] = value;
            applyFilters();
        }

        /**
         * Set view mode (weekly/monthly)
         */
        function setViewMode(mode) {
            state.viewMode = mode;
            state.filters.month = 'All';
            state.filters.week = 'All';
            applyFilters();
        }

        // ================== METRICS CALCULATION ==================

        /**
         * Calculate all metrics for current filtered data
         */
        function calculateMetrics() {
            if (state.filteredData.length === 0) {
                return {
                    overall: { 
                        utilization: '', 
                        trainingHours: '0.0', 
                        blockHours: '0.0' 
                    },
                    subgroups: [],
                    teams: [],
                    coaches: [],
                    trend: []
                };
            }
            
            const isWeekly = state.viewMode === 'weekly';
            
            // Calculate overall totals
            const totalTraining = state.filteredData.reduce((sum, d) => 
                sum + (isWeekly ? d.weeklyTrainingHours : d.monthlyTrainingHours), 0
            );
            const totalBlock = state.filteredData.reduce((sum, d) => 
                sum + (isWeekly ? d.weeklyBlockHours : d.monthlyBlockHours), 0
            );

            // Calculate by subgroup
            const subgroups = calculateGroupMetrics(
                state.filteredData,
                isWeekly ? 'weeklySubgroup' : 'monthlySubgroup',
                isWeekly
            );

            // Add overall row to subgroups
            const subgroupOverall = {
                name: 'Overall',
                training: totalTraining.toFixed(1),
                block: totalBlock.toFixed(1),
                utilization: calculateUtilization(totalTraining, totalBlock)
            };

            // Calculate by team
            const teams = calculateGroupMetrics(
                state.filteredData,
                isWeekly ? 'weeklyTeam' : 'monthlyTeam',
                isWeekly,
                30 // max name length
            );

            // Calculate by coach
            const coaches = calculateGroupMetrics(
                state.filteredData,
                isWeekly ? 'weeklyCoach' : 'monthlyCoach',
                isWeekly,
                25 // max name length
            );

            // Calculate trend data
            const trend = calculateTrendData(state.filteredData, isWeekly);

            return {
                overall: {
                    utilization: calculateUtilization(totalTraining, totalBlock) || '0.00',
                    trainingHours: totalTraining.toFixed(1),
                    blockHours: totalBlock.toFixed(1)
                },
                subgroups: [subgroupOverall, ...subgroups],
                teams,
                coaches,
                trend
            };
        }

        /**
         * Calculate metrics grouped by a specific field
         */
        function calculateGroupMetrics(data, groupField, isWeekly, maxNameLength = null) {
            const groups = {};
            
            data.forEach(row => {
                const key = row[groupField];
                if (!isValidValue(key)) return;
                
                if (!groups[key]) {
                    groups[key] = { training: 0, block: 0 };
                }
                
                groups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                groups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });

            return Object.entries(groups)
                .map(([name, data]) => {
                    const truncatedName = maxNameLength && name.length > maxNameLength
                        ? name.substring(0, maxNameLength) + '...'
                        : name;
                    
                    return {
                        name: truncatedName,
                        training: data.training.toFixed(1),
                        block: data.block.toFixed(1),
                        utilization: calculateUtilization(data.training, data.block)
                    };
                })
                .sort((a, b) => {
                    const aVal = a.utilization === '' ? -1 : parseFloat(a.utilization);
                    const bVal = b.utilization === '' ? -1 : parseFloat(b.utilization);
                    return bVal - aVal;
                });
        }

        /**
         * Calculate trend data over time
         */
        function calculateTrendData(data, isWeekly) {
            const timeGroups = {};
            
            data.forEach(row => {
                const key = isWeekly 
                    ? (row.weekStart ? formatDate(row.weekStart) : null)
                    : row.monthlyYearMonth;
                
                if (!key || !isValidValue(key)) return;
                
                if (!timeGroups[key]) {
                    timeGroups[key] = { training: 0, block: 0 };
                }
                
                timeGroups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                timeGroups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });

            let trend = Object.entries(timeGroups).map(([time, data]) => ({
                time,
                utilization: calculateUtilization(data.training, data.block) || '0'
            }));

            // Sort trend data
            if (isWeekly) {
                // Sort weekly data by date
                trend.sort((a, b) => a.time.localeCompare(b.time));
                
                // For weekly view, show last 8 weeks
                if (trend.length > 0) {
                    const latestWeek = state.filters.week !== 'All' 
                        ? state.filters.week 
                        : trend[trend.length - 1].time;
                    const idx = trend.findIndex(d => d.time === latestWeek);
                    if (idx >= 0) {
                        trend = trend.slice(Math.max(0, idx - 7), idx + 1);
                    }
                }
            } else {
                // Sort monthly data chronologically
                trend.sort((a, b) => {
                    const dateA = parseMonthString(a.time);
                    const dateB = parseMonthString(b.time);
                    if (!dateA || !dateB) return 0;
                    return dateA - dateB;
                });
            }

            return trend;
        }

        // ================== UI RENDERING ==================

        /**
         * Show upload screen
         */
        function showUploadScreen() {
            const downloadUrl = `https://raw.githubusercontent.com/${CONFIG.GITHUB_USERNAME}/${CONFIG.GITHUB_REPO}/main/${encodeURIComponent(CONFIG.EXCEL_FILENAME)}`;
            
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="card" style="max-width: 800px; margin: 4rem auto;">
                        <div class="text-center mb-4">
                            <h1>üìä Training Block Dashboard</h1>
                            <p>Choose how to load your data</p>
                        </div>
                        
                        <div class="border-box border-purple mb-3">
                            <h3 class="mb-3">üöÄ Quick Load (Recommended)</h3>
                            <button onclick="autoLoadFromGitHub()" class="btn btn-purple" style="width: 100%; padding: 1rem; font-size: 1.125rem;">
                                ‚ö° Auto-Load Latest Data
                            </button>
                            <p class="text-small mt-2 text-center">Loads the latest file from GitHub automatically</p>
                        </div>

                        <div class="text-center mb-3" style="color: #94a3b8; font-weight: 600;">OR</div>

                        <div class="border-box border-blue">
                            <h3 class="mb-3">üì• Manual Upload</h3>
                            <a href="${downloadUrl}" download="${CONFIG.EXCEL_FILENAME}" class="btn btn-blue mb-3" style="display: block; text-align: center; text-decoration: none; padding: 0.75rem;">
                                ‚¨áÔ∏è Download Data File
                            </a>
                            <input type="file" accept=".xlsx,.xls" class="upload-input" onchange="handleFileUpload(event)">
                        </div>

                        <div class="mt-4" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                            <p class="text-small"><strong>üîí Privacy:</strong> Data stays in your browser only.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Show loading screen
         */
        function showLoadingScreen(message, subtitle = '') {
            document.getElementById('app').innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div class="text-center">
                        <div class="spinner mb-4"></div>
                        <p style="font-size: 1.5rem; font-weight: 600; color: #1e293b;">${message}</p>
                        ${subtitle ? `<p class="text-small mt-2">${subtitle}</p>` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Show error screen
         */
        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem;">
                    <div class="card text-center" style="max-width: 600px;">
                        <div style="color: #dc2626; font-size: 4rem; margin-bottom: 1rem;">‚úï</div>
                        <h2>Error</h2>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">${message}</p>
                        <button onclick="showUploadScreen()" class="btn btn-primary">Back</button>
                    </div>
                </div>
            `;
        }

        /**
         * Render the main dashboard
         */
        function renderDashboard() {
            const options = getFilterOptions();
            const metrics = calculateMetrics();
            const isWeekly = state.viewMode === 'weekly';

            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="card">
                        <div class="flex-between mb-4">
                            <div>
                                <h1>Training Block Utilization Dashboard</h1>
                                <p style="color: #64748b;">Viewing ${state.rawData.length} records</p>
                            </div>
                            <div class="flex flex-gap">
                                <button onclick="autoLoadFromGitHub()" class="btn btn-purple">‚ö° Reload</button>
                                <button onclick="showUploadScreen()" class="btn btn-primary">üìÅ Upload</button>
                            </div>
                        </div>
                        <div class="flex flex-gap">
                            <button onclick="setViewMode('weekly')" class="btn ${state.viewMode === 'weekly' ? 'btn-primary' : 'btn-secondary'}">
                                Weekly View
                            </button>
                            <button onclick="setViewMode('monthly')" class="btn ${state.viewMode === 'monthly' ? 'btn-primary' : 'btn-secondary'}">
                                Monthly View
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üîç Filters</h2>
                        <div class="grid grid-4">
                            <div>
                                <label>Coach</label>
                                <select onchange="updateFilter('coach', this.value)">
                                    <option value="All">All Coaches</option>
                                    ${options.coaches.map(c => 
                                        `<option value="${c}" ${state.filters.coach === c ? 'selected' : ''}>${c}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label>Team</label>
                                <select onchange="updateFilter('team', this.value)">
                                    <option value="All">All Teams</option>
                                    ${options.teams.map(t => 
                                        `<option value="${t}" ${state.filters.team === t ? 'selected' : ''}>${t}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label>Subgroup</label>
                                <select onchange="updateFilter('subgroup', this.value)">
                                    <option value="All">All Subgroups</option>
                                    ${options.subgroups.map(s => 
                                        `<option value="${s}" ${state.filters.subgroup === s ? 'selected' : ''}>${s}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ${isWeekly ? `
                            <div>
                                <label>Week</label>
                                <select onchange="updateFilter('week', this.value)">
                                    <option value="All">All Weeks</option>
                                    ${options.weeks.map(w => 
                                        `<option value="${w}" ${state.filters.week === w ? 'selected' : ''}>${w}</option>`
                                    ).join('')}
                                </select>
                            </div>` : `
                            <div>
                                <label>Month</label>
                                <select onchange="updateFilter('month', this.value)">
                                    <option value="All">All Months</option>
                                    ${options.months.map(m => 
                                        `<option value="${m}" ${state.filters.month === m ? 'selected' : ''}>${m}</option>`
                                    ).join('')}
                                </select>
                            </div>`}
                        </div>
                    </div>

                    <div class="header-purple">
                        <h2 style="color: white;">Overall ${isWeekly ? 'Weekly' : 'Monthly'} Utilization</h2>
                        <div class="grid grid-3">
                            <div>
                                <p style="color: #c7d2fe; font-size: 0.875rem; margin-bottom: 0.5rem;">Total Training Hours</p>
                                <p style="font-size: 2rem; font-weight: bold;">${metrics.overall.trainingHours}</p>
                            </div>
                            <div>
                                <p style="color: #c7d2fe; font-size: 0.875rem; margin-bottom: 0.5rem;">Total Training Block Hours</p>
                                <p style="font-size: 2rem; font-weight: bold;">${metrics.overall.blockHours}</p>
                            </div>
                            <div>
                                <p style="color: #c7d2fe; font-size: 0.875rem; margin-bottom: 0.5rem;">Utilization Rate</p>
                                <p style="font-size: 2rem; font-weight: bold;">${metrics.overall.utilization || '-'}%</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>${isWeekly ? 'Weekly Trend (Last 8 Weeks)' : 'Monthly Trend'}</h3>
                        <canvas id="trendChart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="grid grid-2">
                        <div class="card">
                            <h3>By Subgroup</h3>
                            <canvas id="subgroupChart"></canvas>
                        </div>
                        <div class="card">
                            <h3>By Team</h3>
                            <canvas id="teamChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3>By Coach</h3>
                        <canvas id="coachChart"></canvas>
                    </div>

                    <div class="grid grid-3">
                        ${renderSummaryTable('Subgroup', metrics.subgroups)}
                        ${renderSummaryTable('Team', metrics.teams)}
                        ${renderSummaryTable('Coach', metrics.coaches)}
                    </div>
                </div>
            `;

            setTimeout(() => renderCharts(metrics), 100);
        }

        /**
         * Render summary table
         */
        function renderSummaryTable(title, data) {
            return `
                <div class="card">
                    <h3>${title} Summary</h3>
                    <div class="overflow-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>${title}</th>
                                    <th class="text-right">Training</th>
                                    <th class="text-right">Training Block</th>
                                    <th class="text-right">Util %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(row => `
                                    <tr class="${row.name === 'Overall' ? 'highlight-row' : ''}">
                                        <td>${row.name}</td>
                                        <td class="text-right">${row.training}</td>
                                        <td class="text-right">${row.block}</td>
                                        <td class="text-right">
                                            ${row.utilization !== '' 
                                                ? `<span class="${getUtilizationColor(row.utilization)}">${row.utilization}%</span>` 
                                                : '<span class="text-gray">-</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * Render all charts
         */
        function renderCharts(metrics) {
            // Destroy existing charts
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Trend Chart
            if (document.getElementById('trendChart')) {
                const trendData = metrics.trend.filter(d => d.utilization !== '');
                state.charts.trend = new Chart(document.getElementById('trendChart'), {
                    type: 'line',
                    data: {
                        labels: trendData.map(d => d.time),
                        datasets: [{
                            label: 'Utilization %',
                            data: trendData.map(d => parseFloat(d.utilization)),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Utilization %'
                                }
                            }
                        }
                    }
                });
            }

            // Subgroup Chart
            if (document.getElementById('subgroupChart')) {
                const subgroupData = metrics.subgroups.filter(s => 
                    s.utilization !== '' && s.name !== 'Overall'
                );
                state.charts.subgroup = new Chart(document.getElementById('subgroupChart'), {
                    type: 'bar',
                    data: {
                        labels: subgroupData.map(s => s.name),
                        datasets: [{
                            label: 'Utilization %',
                            data: subgroupData.map(s => parseFloat(s.utilization)),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Utilization %'
                                }
                            }
                        }
                    }
                });
            }

            // Team Chart
            if (document.getElementById('teamChart')) {
                const teamData = metrics.teams.filter(t => t.utilization !== '');
                state.charts.team = new Chart(document.getElementById('teamChart'), {
                    type: 'bar',
                    data: {
                        labels: teamData.map(t => t.name),
                        datasets: [{
                            label: 'Utilization %',
                            data: teamData.map(t => parseFloat(t.utilization)),
                            backgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Utilization %'
                                }
                            }
                        }
                    }
                });
            }

            // Coach Chart
            if (document.getElementById('coachChart')) {
                const coachData = metrics.coaches.filter(c => c.utilization !== '');
                state.charts.coach = new Chart(document.getElementById('coachChart'), {
                    type: 'bar',
                    data: {
                        labels: coachData.map(c => c.name),
                        datasets: [{
                            label: 'Utilization %',
                            data: coachData.map(c => parseFloat(c.utilization)),
                            backgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Utilization %'
                                }
                            }
                        }
                    }
                });
            }
        }

        // ================== FILE LOADING ==================

        /**
         * Auto-load data from GitHub
         */
        async function autoLoadFromGitHub() {
            showLoadingScreen('Auto-Loading Latest Data...', 'Fetching from GitHub');

            try {
                const fileUrl = `https://raw.githubusercontent.com/${CONFIG.GITHUB_USERNAME}/${CONFIG.GITHUB_REPO}/main/${encodeURIComponent(CONFIG.EXCEL_FILENAME)}`;
                const response = await fetch(fileUrl);
                
                if (!response.ok) {
                    throw new Error('File not found. Please upload the Excel file to GitHub first.');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                await processExcelFile(arrayBuffer);
            } catch (error) {
                showError(error.message);
            }
        }

        /**
         * Handle manual file upload
         */
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingScreen('Processing File...', file.name);

            try {
                const arrayBuffer = await file.arrayBuffer();
                await processExcelFile(arrayBuffer);
            } catch (error) {
                showError(error.message);
            }
        }

        // ================== INITIALIZATION ==================
        showUploadScreen();
    </script>
</body>
</html>
