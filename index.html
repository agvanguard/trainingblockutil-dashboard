<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Block Utilization Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div id="app"></div>
    
    <script>
        // GitHub repository configuration
        const GITHUB_USERNAME = 'agvanguard';
        const GITHUB_REPO = 'trainingblockutil-dashboard';
        const EXCEL_FILENAME = 'Training Block Report Raw Data.xlsx';

        // State
        let rawData = [];
        let filteredData = [];
        let viewMode = 'weekly';
        let filters = { coach: 'All', team: 'All', subgroup: 'All', month: 'All', week: 'All' };
        let charts = { trend: null, subgroup: null, team: null, coach: null };

        // Helper functions
        function excelDateToJSDate(serial) {
            if (!serial || isNaN(serial)) return null;
            // Excel serial date: day 1 = Jan 1, 1900
            // Need to add 1 day to match Excel's displayed Monday dates
            const daysFromEpoch = serial - 1;
            const excelEpoch = new Date(1900, 0, 1);
            const result = new Date(excelEpoch);
            result.setDate(result.getDate() + daysFromEpoch + 1); // +1 to match Excel Monday dates
            return new Date(result.getFullYear(), result.getMonth(), result.getDate());
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getColor(utilization) {
            const val = parseFloat(utilization);
            return val >= 50 ? 'text-green-600' : val >= 1 ? 'text-yellow-600' : 'text-red-600';
        }

        // Show upload screen with auto-load option
        function showUploadScreen() {
            const downloadUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${encodeURIComponent(EXCEL_FILENAME)}`;
            
            document.getElementById('app').innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center p-6">
                    <div class="bg-white rounded-lg shadow-2xl p-12 max-w-2xl w-full">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-slate-800 mb-4">üìä Training Block Dashboard</h1>
                            <p class="text-slate-600">Choose how to load your data</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-6 mb-4">
                            <h3 class="font-semibold text-purple-900 mb-3">üöÄ Quick Load (Recommended)</h3>
                            <button onclick="autoLoadFromGitHub()" 
                               class="block w-full bg-purple-600 text-white text-center px-6 py-4 rounded-lg hover:bg-purple-700 font-semibold text-lg">
                                ‚ö° Auto-Load Latest Data
                            </button>
                            <p class="text-xs text-slate-600 mt-2 text-center">Automatically loads the latest file from GitHub</p>
                        </div>

                        <div class="text-center my-4 text-slate-400 font-semibold">OR</div>

                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-6 mb-4">
                            <h3 class="font-semibold text-blue-900 mb-3">üì• Manual Download & Upload</h3>
                            <a href="${downloadUrl}" download="${EXCEL_FILENAME}"
                               class="block w-full bg-blue-600 text-white text-center px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold mb-3">
                                ‚¨áÔ∏è Download Data File
                            </a>
                            <input type="file" accept=".xlsx,.xls" 
                                   class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-600 file:text-white hover:file:bg-green-700 cursor-pointer"
                                   onchange="handleFileUpload(event)">
                        </div>

                        <div class="mt-6 bg-slate-50 border border-slate-200 rounded-lg p-4">
                            <p class="text-xs text-slate-600">
                                <strong>üîí Privacy:</strong> Data stays in your browser only. Nothing is sent to any server.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auto-load file from GitHub
        async function autoLoadFromGitHub() {
            document.getElementById('app').innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mb-4"></div>
                        <p class="text-2xl font-semibold text-slate-800">Auto-Loading Latest Data...</p>
                        <p class="text-sm text-slate-600 mt-2">Fetching from GitHub repository</p>
                    </div>
                </div>
            `;

            try {
                const fileUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/${encodeURIComponent(EXCEL_FILENAME)}`;
                const response = await fetch(fileUrl);
                
                if (!response.ok) throw new Error('File not found on GitHub. Please upload the Excel file to your repository first.');
                
                const arrayBuffer = await response.arrayBuffer();
                await processExcelFile(arrayBuffer);
                
            } catch (error) {
                showError(error.message);
            }
        }

        // Handle manual file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('app').innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
                        <p class="text-2xl font-semibold text-slate-800">Processing File...</p>
                        <p class="text-sm text-slate-600 mt-2">${file.name}</p>
                    </div>
                </div>
            `;

            try {
                const arrayBuffer = await file.arrayBuffer();
                await processExcelFile(arrayBuffer);
            } catch (error) {
                showError(error.message);
            }
        }

        // Process Excel file
        async function processExcelFile(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer);
                const sheetName = workbook.SheetNames.includes("Raw Data") ? "Raw Data" : workbook.SheetNames[0];
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

                // Helper to check if value is an error
                const isErrorValue = (val) => {
                    if (!val) return false;
                    const str = String(val).trim();
                    return str === '#N/A' || str === '#VALUE!' || str === 'NA' || str === '#REF!' || 
                           str === '#DIV/0!' || str === '#NUM!' || str === '#NAME?' || str === '#NULL!' ||
                           str.startsWith('#');
                };

                rawData = data.map(row => {
                    let weekStartDate = null;
                    const weekStartValue = row["Week Start"];
                    if (weekStartValue && !isErrorValue(weekStartValue)) {
                        if (typeof weekStartValue === 'number') weekStartDate = excelDateToJSDate(weekStartValue);
                        else if (weekStartValue instanceof Date) weekStartDate = weekStartValue;
                        else if (typeof weekStartValue === 'string') weekStartDate = new Date(weekStartValue);
                    }
                    
                    // Clean helper function
                    const cleanValue = (val) => (val && !isErrorValue(val)) ? val : "";
                    const cleanNumber = (val) => {
                        if (!val || isErrorValue(val)) return 0;
                        const num = parseFloat(val);
                        return isNaN(num) ? 0 : num;
                    };
                    
                    return {
                        weeklyYearMonth: cleanValue(row["Year - Month"]),
                        weekStart: weekStartDate,
                        weeklySubgroup: cleanValue(row.Subgroup),
                        weeklyCoach: cleanValue(row.Coach),
                        weeklyTeam: cleanValue(row.Team),
                        weeklyTrainingHours: cleanNumber(row["Training Total Hours"]),
                        weeklyBlockHours: cleanNumber(row["Total Training Block Hours"]),
                        monthlyYearMonth: cleanValue(row["Year - Month_1"]),
                        monthlySubgroup: cleanValue(row["Subgroup_1"]),
                        monthlyTrainingHours: cleanNumber(row["Training Total Hours_1"]),
                        monthlyBlockHours: cleanNumber(row["Total Training Block Hours_1"]),
                        monthlyCoach: cleanValue(row["Coach_1"]) || cleanValue(row.Coach),
                        monthlyTeam: cleanValue(row["Team_1"]) || cleanValue(row.Team)
                    };
                }).filter(row => row.weekStart && !isNaN(row.weekStart));

                filteredData = [...rawData];
                renderDashboard();
            } catch (error) {
                throw new Error('Error processing Excel file: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center p-6">
                    <div class="max-w-2xl bg-white rounded-lg shadow-lg p-8 text-center">
                        <div class="text-red-600 mb-4 text-6xl">‚úï</div>
                        <h2 class="text-2xl font-bold mb-4">Error</h2>
                        <p class="text-slate-600 mb-6">${message}</p>
                        <button onclick="showUploadScreen()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            Back
                        </button>
                    </div>
                </div>
            `;
        }

        function applyFilters() {
            filteredData = [...rawData];
            const isWeekly = viewMode === 'weekly';
            
            if (filters.coach !== 'All') filteredData = filteredData.filter(d => (isWeekly ? d.weeklyCoach : d.monthlyCoach) === filters.coach);
            if (filters.team !== 'All') filteredData = filteredData.filter(d => (isWeekly ? d.weeklyTeam : d.monthlyTeam) === filters.team);
            if (filters.subgroup !== 'All') filteredData = filteredData.filter(d => (isWeekly ? d.weeklySubgroup : d.monthlySubgroup) === filters.subgroup);
            if (!isWeekly && filters.month !== 'All') filteredData = filteredData.filter(d => d.monthlyYearMonth === filters.month);
            if (isWeekly && filters.week !== 'All') filteredData = filteredData.filter(d => d.weekStart && formatDate(d.weekStart) === filters.week);
            
            renderDashboard();
        }

        function getFilterOptions() {
            const isWeekly = viewMode === 'weekly';
            return {
                coaches: [...new Set(rawData.map(d => isWeekly ? d.weeklyCoach : d.monthlyCoach).filter(c => c && c !== "#N/A"))].sort(),
                teams: [...new Set(rawData.map(d => isWeekly ? d.weeklyTeam : d.monthlyTeam).filter(t => t && t !== "#N/A"))].sort(),
                subgroups: [...new Set(rawData.map(d => isWeekly ? d.weeklySubgroup : d.monthlySubgroup).filter(s => s && s !== "#N/A"))].sort(),
                weeks: [...new Set(rawData.filter(d => d.weekStart).map(d => formatDate(d.weekStart)))].sort(),
                months: [...new Set(rawData.map(d => isWeekly ? d.weeklyYearMonth : d.monthlyYearMonth).filter(m => m && m !== "#N/A"))].sort()
            };
        }

        function calculateMetrics() {
            if (filteredData.length === 0) return { overall: { utilization: 0, trainingHours: 0, blockHours: 0 }, subgroups: [], teams: [], coaches: [], trend: [] };
            
            const isWeekly = viewMode === 'weekly';
            const totalTraining = filteredData.reduce((sum, d) => sum + (isWeekly ? d.weeklyTrainingHours : d.monthlyTrainingHours), 0);
            const totalBlock = filteredData.reduce((sum, d) => sum + (isWeekly ? d.weeklyBlockHours : d.monthlyBlockHours), 0);

            const subgroupGroups = {};
            filteredData.forEach(row => {
                const key = isWeekly ? row.weeklySubgroup : row.monthlySubgroup;
                if (!key || key === "#N/A") return;
                if (!subgroupGroups[key]) subgroupGroups[key] = { training: 0, block: 0 };
                subgroupGroups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                subgroupGroups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });
            const subgroups = Object.entries(subgroupGroups).map(([name, d]) => ({
                name, training: d.training.toFixed(1), block: d.block.toFixed(1),
                utilization: (d.block > 0 ? (d.training / d.block) * 100 : 0).toFixed(2)
            })).sort((a, b) => parseFloat(b.utilization) - parseFloat(a.utilization));

            const subgroupOverall = {
                name: 'Overall',
                training: subgroups.reduce((sum, s) => sum + parseFloat(s.training), 0).toFixed(1),
                block: subgroups.reduce((sum, s) => sum + parseFloat(s.block), 0).toFixed(1),
                utilization: totalBlock > 0 ? ((totalTraining / totalBlock) * 100).toFixed(2) : '0.00'
            };

            const teamGroups = {};
            filteredData.forEach(row => {
                const key = isWeekly ? row.weeklyTeam : row.monthlyTeam;
                if (!key || key === "#N/A") return;
                if (!teamGroups[key]) teamGroups[key] = { training: 0, block: 0 };
                teamGroups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                teamGroups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });
            const teams = Object.entries(teamGroups).map(([name, d]) => ({
                name: name.length > 30 ? name.substring(0, 30) + '...' : name,
                training: d.training.toFixed(1), block: d.block.toFixed(1),
                utilization: (d.block > 0 ? (d.training / d.block) * 100 : 0).toFixed(2)
            })).sort((a, b) => parseFloat(b.utilization) - parseFloat(a.utilization));

            const coachGroups = {};
            filteredData.forEach(row => {
                const key = isWeekly ? row.weeklyCoach : row.monthlyCoach;
                if (!key || key === "#N/A") return;
                if (!coachGroups[key]) coachGroups[key] = { training: 0, block: 0 };
                coachGroups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                coachGroups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });
            const coaches = Object.entries(coachGroups).map(([name, d]) => ({
                name: name.length > 25 ? name.substring(0, 25) + '...' : name,
                training: d.training.toFixed(1), block: d.block.toFixed(1),
                utilization: (d.block > 0 ? (d.training / d.block) * 100 : 0).toFixed(2)
            })).sort((a, b) => parseFloat(b.utilization) - parseFloat(a.utilization));

            const timeGroups = {};
            filteredData.forEach(row => {
                const key = isWeekly ? (row.weekStart ? formatDate(row.weekStart) : null) : row.monthlyYearMonth;
                if (!key) return;
                if (!timeGroups[key]) timeGroups[key] = { training: 0, block: 0 };
                timeGroups[key].training += isWeekly ? row.weeklyTrainingHours : row.monthlyTrainingHours;
                timeGroups[key].block += isWeekly ? row.weeklyBlockHours : row.monthlyBlockHours;
            });
            let trend = Object.entries(timeGroups).map(([time, d]) => ({
                time, utilization: (d.block > 0 ? (d.training / d.block) * 100 : 0).toFixed(1)
            })).sort((a, b) => a.time.localeCompare(b.time));

            if (isWeekly && trend.length > 0) {
                const latestWeek = filters.week !== 'All' ? filters.week : trend[trend.length - 1].time;
                const idx = trend.findIndex(d => d.time === latestWeek);
                if (idx >= 0) trend = trend.slice(Math.max(0, idx - 7), idx + 1);
            }

            return {
                overall: { utilization: (totalBlock > 0 ? (totalTraining / totalBlock) * 100 : 0).toFixed(2), trainingHours: totalTraining.toFixed(1), blockHours: totalBlock.toFixed(1) },
                subgroups: [subgroupOverall, ...subgroups], teams, coaches, trend
            };
        }

        function renderDashboard() {
            const options = getFilterOptions();
            const metrics = calculateMetrics();
            const isWeekly = viewMode === 'weekly';

            document.getElementById('app').innerHTML = `
                <div class="w-full min-h-screen p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-slate-800 mb-2">Training Block Utilization Dashboard</h1>
                                    <p class="text-slate-600">Viewing ${rawData.length} records</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="autoLoadFromGitHub()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-semibold">
                                        ‚ö° Reload Data
                                    </button>
                                    <button onclick="showUploadScreen()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">
                                        üìÅ Upload File
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="setViewMode('weekly')" class="px-6 py-2 rounded-lg font-semibold ${viewMode === 'weekly' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700'}">Weekly View</button>
                                <button onclick="setViewMode('monthly')" class="px-6 py-2 rounded-lg font-semibold ${viewMode === 'monthly' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-700'}">Monthly View</button>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 class="text-xl font-semibold mb-4">üîç Filters</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Coach</label>
                                    <select onchange="updateFilter('coach', this.value)" class="w-full p-2 border rounded-lg">
                                        <option value="All">All Coaches</option>
                                        ${options.coaches.map(c => `<option value="${c}" ${filters.coach === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Team</label>
                                    <select onchange="updateFilter('team', this.value)" class="w-full p-2 border rounded-lg">
                                        <option value="All">All Teams</option>
                                        ${options.teams.map(t => `<option value="${t}" ${filters.team === t ? 'selected' : ''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Subgroup</label>
                                    <select onchange="updateFilter('subgroup', this.value)" class="w-full p-2 border rounded-lg">
                                        <option value="All">All Subgroups</option>
                                        ${options.subgroups.map(s => `<option value="${s}" ${filters.subgroup === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                                ${isWeekly ? `
                                <div>
                                    <label class="block text-sm font-medium mb-2">Week</label>
                                    <select onchange="updateFilter('week', this.value)" class="w-full p-2 border rounded-lg">
                                        <option value="All">All Weeks</option>
                                        ${options.weeks.map(w => `<option value="${w}" ${filters.week === w ? 'selected' : ''}>${w}</option>`).join('')}
                                    </select>
                                </div>
                                ` : `
                                <div>
                                    <label class="block text-sm font-medium mb-2">Month</label>
                                    <select onchange="updateFilter('month', this.value)" class="w-full p-2 border rounded-lg">
                                        <option value="All">All Months</option>
                                        ${options.months.map(m => `<option value="${m}" ${filters.month === m ? 'selected' : ''}>${m}</option>`).join('')}
                                    </select>
                                </div>
                                `}
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow-lg p-6 mb-6 text-white">
                            <h2 class="text-2xl font-bold mb-4">Overall ${isWeekly ? 'Weekly' : 'Monthly'} Utilization</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div><p class="text-indigo-100 text-sm mb-2">Total Training Hours</p><p class="text-3xl font-bold">${metrics.overall.trainingHours}</p></div>
                                <div><p class="text-indigo-100 text-sm mb-2">Total Block Hours</p><p class="text-3xl font-bold">${metrics.overall.blockHours}</p></div>
                                <div><p class="text-indigo-100 text-sm mb-2">Utilization Rate</p><p class="text-3xl font-bold">${metrics.overall.utilization}%</p></div>
                            </div>
                            <p class="mt-4 text-indigo-100 text-sm">(Training Hours √∑ Block Hours) √ó 100 ${isWeekly ? '| Columns G & H' : '| Columns T & U'}</p>
                        </div>

                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">${isWeekly ? 'Weekly Utilization Trend (Last 8 Weeks)' : 'Monthly Utilization Trend'}</h3>
                            <canvas id="trendChart" style="max-height: 300px;"></canvas>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">Utilization by Subgroup</h3>
                                <canvas id="subgroupChart"></canvas>
                            </div>
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">Utilization by Team</h3>
                                <canvas id="teamChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">Utilization by Coach</h3>
                            <canvas id="coachChart"></canvas>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">Subgroup Summary</h3>
                                <div class="overflow-auto max-h-96">
                                    <table class="w-full text-sm">
                                        <thead class="sticky top-0 bg-slate-100">
                                            <tr>
                                                <th class="px-3 py-2 text-left font-semibold">Subgroup</th>
                                                <th class="px-3 py-2 text-right font-semibold">Training</th>
                                                <th class="px-3 py-2 text-right font-semibold">Block</th>
                                                <th class="px-3 py-2 text-right font-semibold">Util %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${metrics.subgroups.map(row => `
                                                <tr class="border-b hover:bg-slate-50 ${row.name === 'Overall' ? 'bg-blue-50 font-semibold' : ''}">
                                                    <td class="px-3 py-2">${row.name}</td>
                                                    <td class="px-3 py-2 text-right">${row.training}</td>
                                                    <td class="px-3 py-2 text-right">${row.block}</td>
                                                    <td class="px-3 py-2 text-right"><span class="font-semibold ${getColor(row.utilization)}">${row.utilization}%</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">Team Summary</h3>
                                <div class="overflow-auto max-h-96">
                                    <table class="w-full text-sm">
                                        <thead class="sticky top-0 bg-slate-100">
                                            <tr>
                                                <th class="px-3 py-2 text-left font-semibold">Team</th>
                                                <th class="px-3 py-2 text-right font-semibold">Training</th>
                                                <th class="px-3 py-2 text-right font-semibold">Block</th>
                                                <th class="px-3 py-2 text-right font-semibold">Util %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${metrics.teams.map(row => `
                                                <tr class="border-b hover:bg-slate-50">
                                                    <td class="px-3 py-2">${row.name}</td>
                                                    <td class="px-3 py-2 text-right">${row.training}</td>
                                                    <td class="px-3 py-2 text-right">${row.block}</td>
                                                    <td class="px-3 py-2 text-right"><span class="font-semibold ${getColor(row.utilization)}">${row.utilization}%</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">Coach Summary</h3>
                                <div class="overflow-auto max-h-96">
                                    <table class="w-full text-sm">
                                        <thead class="sticky top-0 bg-slate-100">
                                            <tr>
                                                <th class="px-3 py-2 text-left font-semibold">Coach</th>
                                                <th class="px-3 py-2 text-right font-semibold">Training</th>
                                                <th class="px-3 py-2 text-right font-semibold">Block</th>
                                                <th class="px-3 py-2 text-right font-semibold">Util %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${metrics.coaches.map(row => `
                                                <tr class="border-b hover:bg-slate-50">
                                                    <td class="px-3 py-2">${row.name}</td>
                                                    <td class="px-3 py-2 text-right">${row.training}</td>
                                                    <td class="px-3 py-2 text-right">${row.block}</td>
                                                    <td class="px-3 py-2 text-right"><span class="font-semibold ${getColor(row.utilization)}">${row.utilization}%</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => renderCharts(metrics), 100);
        }

        function renderCharts(metrics) {
            Object.values(charts).forEach(chart => chart && chart.destroy());

            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                charts.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: metrics.trend.map(d => d.time),
                        datasets: [{ label: 'Utilization %', data: metrics.trend.map(d => d.utilization), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3 }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            const subgroupCtx = document.getElementById('subgroupChart');
            if (subgroupCtx) {
                charts.subgroup = new Chart(subgroupCtx, {
                    type: 'bar',
                    data: {
                        labels: metrics.subgroups.map(s => s.name),
                        datasets: [{ label: 'Utilization %', data: metrics.subgroups.map(s => s.utilization), backgroundColor: '#10b981' }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true }
                });
            }

            const teamCtx = document.getElementById('teamChart');
            if (teamCtx) {
                charts.team = new Chart(teamCtx, {
                    type: 'bar',
                    data: {
                        labels: metrics.teams.map(t => t.name),
                        datasets: [{ label: 'Utilization %', data: metrics.teams.map(t => t.utilization), backgroundColor: '#f59e0b' }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true }
                });
            }

            const coachCtx = document.getElementById('coachChart');
            if (coachCtx) {
                charts.coach = new Chart(coachCtx, {
                    type: 'bar',
                    data: {
                        labels: metrics.coaches.map(c => c.name),
                        datasets: [{ label: 'Utilization %', data: metrics.coaches.map(c => c.utilization), backgroundColor: '#8b5cf6' }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true }
                });
            }
        }

        function setViewMode(mode) {
            viewMode = mode;
            filters.month = 'All';
            filters.week = 'All';
            applyFilters();
        }

        function updateFilter(key, value) {
            filters[key] = value;
            applyFilters();
        }

        // Show upload screen on page load
        showUploadScreen();
    </script>
</body>
</html>
